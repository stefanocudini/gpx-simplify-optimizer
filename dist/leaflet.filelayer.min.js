var FileLoader=L.Class.extend({includes:L.Mixin.Events,options:{layerOptions:{},fileSizeLimit:1024},initialize:function(a,b){this._map=a,L.Util.setOptions(this,b),this._parsers=L.Util.extend({geojson:this._loadGeoJSON,gpx:this._convertToGeoJSON,kml:this._convertToGeoJSON},this.options.parsers),this.options.binaryFormats&&(this._binaryFormats=[].concat(this.options.binaryFormats))},load:function(a){var b=(a.size/1024).toFixed(4);if(b>this.options.fileSizeLimit)return void this.fire("data:error",{error:new Error("File size exceeds limit ("+b+" > "+this.options.fileSizeLimit+"kb)")});var c=a.name.split(".").pop(),d=this._parsers[c];if(!d)return void this.fire("data:error",{error:new Error("Unsupported file type "+a.type+"("+c+")")});var e=new FileReader;return e.onload=L.Util.bind(function(b){try{this.fire("data:loading",{filename:a.name,format:c});var e=d.call(this,b.target.result,c);this.fire("data:loaded",{layer:e,filename:a.name,format:c})}catch(f){this.fire("data:error",{error:f})}},this),-1!==this._binaryFormats.indexOf(c)?e.readAsArrayBuffer(a):e.readAsText(a),e},_loadGeoJSON:function(a){"string"==typeof a&&(a=JSON.parse(a));var b=L.geoJson(a,this.options.layerOptions);if(0===b.getLayers().length)throw new Error("GeoJSON has no valid layers.");return this.options.addToMap&&b.addTo(this._map),b},_convertToGeoJSON:function(a,b){"string"==typeof a&&(a=(new window.DOMParser).parseFromString(a,"text/xml"));var c=toGeoJSON[b](a);return this._loadGeoJSON(c)}});L.Control.FileLayerLoad=L.Control.extend({statics:{TITLE:"Load local file (GPX, KML, GeoJSON)",LABEL:"&#8965;"},options:{position:"topleft",fitBounds:!0,layerOptions:{},addToMap:!0,fileSizeLimit:1024},initialize:function(a){L.Util.setOptions(this,a),this.loader=null},onAdd:function(a){return this.loader=new FileLoader(a,this.options),this.loader.on("data:loaded",function(b){this.options.fitBounds&&window.setTimeout(function(){a.fitBounds(b.layer.getBounds())},500)},this),this._initDragAndDrop(a),this._initContainer()},_initDragAndDrop:function(a){var b=this.loader,c=a._container,d={dragenter:function(){a.scrollWheelZoom.disable()},dragleave:function(){a.scrollWheelZoom.enable()},dragover:function(a){a.stopPropagation(),a.preventDefault()},drop:function(c){c.stopPropagation(),c.preventDefault();{var d=Array.prototype.slice.apply(c.dataTransfer.files);d.length}setTimeout(function(){b.load(d.shift()),d.length>0&&setTimeout(arguments.callee,25)},25),a.scrollWheelZoom.enable()}};for(var e in d)c.addEventListener(e,d[e],!1)},_initContainer:function(){var a="leaflet-control-filelayer leaflet-control-zoom",b="leaflet-bar",c=b+"-part",d=L.DomUtil.create("div",a+" "+b),e=L.DomUtil.create("a",a+"-in "+c,d);e.innerHTML=L.Control.FileLayerLoad.LABEL,e.href="#",e.title=L.Control.FileLayerLoad.TITLE;var f=L.DomUtil.create("input","hidden",d);f.type="file",f.accept=this.options.formats?this.options.formats.join(","):".gpx,.kml,.geojson",f.style.display="none";var g=this.loader;return f.addEventListener("change",function(){g.load(this.files[0]),this.value=""},!1),L.DomEvent.disableClickPropagation(e),L.DomEvent.on(e,"click",function(a){f.click(),a.preventDefault()}),d}}),L.Control.fileLayerLoad=function(a){return new L.Control.FileLayerLoad(a)};