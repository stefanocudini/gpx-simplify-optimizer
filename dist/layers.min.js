function updateLayers(){$(".leaflet-control-switcher").html("");for(var a in window.Layers){var b=window.Layers[a];$(".leaflet-control-switcher").append('<option value="'+b.id+'" '+(window.currentLayer.name==b.name?' selected="selected"':"")+">"+b.name+"</option>")}Object.keys(window.Layers).length>0?$(".leaflet-control-switcher-box").show():$(".leaflet-control-switcher-box").hide()}function clearMap(){for(var a in window.Layers)window.Layers[a].remove();window.Layers={},updateLayers()}var LayerOptimizer=function(a){this.id=this.createId(),this.name=a.filename,this.sourceLayer=a.layer,this.size=a.layer.getLayers().length,this.sourceLayerStyle={color:"red",opacity:.7,fillOpacity:.7,weight:5,clickable:!1},this.sourceLayerData=[],this.sourceLayerJSON=[],this.sourceLayerOptions=[],this.sourceLayerNodes=0,this.simplifiedLayerStyle={color:"blue",opacity:1,fillOpacity:1,weight:2,clickable:!1},this.simplifiedLayerData=[],this.simplifiedLayerNodes=0,this.controller=null,this.tolerance=0,this.precision=8,this.rawData=JSON.parse(JSON.stringify(RAW_DATA)),RAW_DATA={},this.init()};LayerOptimizer.prototype={init:function(){for(var a,b=[],c=0;c<this.size;c++)if(a=this.sourceLayer.getLayers()[c].toGeoJSON(),"GeometryCollection"===a.geometry.type)for(var d=0;d<a.geometry.geometries.length;d++){var e=JSON.parse(JSON.stringify(a));e.geometry=a.geometry.geometries[d],e.properties.name=a.properties.name+" #"+d,e.geometry.coordinates=e.geometry.coordinates[0],b.push(e)}else b.push(a);this.size=b.length;for(var f=0;f<this.size;f++)this.initLayer(b[f],f)},initLayer:function(a,b){this.sourceLayerOptions[b]={},"LineString"!==a.geometry.type&&(this.sourceLayerOptions[b].type=a.geometry.type,a.geometry.type="LineString"),this.sourceLayerJSON[b]=a,this.sourceLayerData[b]=L.geoJson(null,{style:this.sourceLayerStyle}).addTo(window.map),this.sourceLayerData[b].addData(a),this.sourceLayerNodes+=a.geometry.coordinates.length,this.simplifiedLayerNodes+=a.geometry.coordinates.length,this.simplifiedLayerData[b]=L.geoJson(a,{style:this.simplifiedLayerStyle}).addTo(window.map)},choose:function(){this.zoom(),this.createLayerGroup(),this.displayInfos(),this.displaySizeFormats(),$("#slider").slider("setValue",this.tolerance),$("#slider2").slider("setValue",this.precision)},optimize:function(a){this.simplifiedLayerNodes=0;for(var b,c,d=[],e=0;e<this.size;e++){b=this.sourceLayerJSON[e].geometry.coordinates;for(var f in b)d.push([parseFloat(b[f][0]).toFixed(this.precision),parseFloat(b[f][1]).toFixed(this.precision)]);d=simplifyGeometry(d,a),c=this.simplifiedLayerData[e].getLayers()[0].toGeoJSON(),1===d.length&&void 0===d[0]&&(d=[]),c.geometry.coordinates=d,this.simplifiedLayerData[e].clearLayers(),this.simplifiedLayerData[e].addData(c),this.simplifiedLayerNodes+=d.length}this.displaySizeFormats(),this.tolerance=a},getBounds:function(){return this.sourceLayer.getBounds()},zoom:function(){window.map.fitBounds(this.getBounds())},createLayerGroup:function(){for(var a,b={},c=0;c<this.size;c++)a=this.sourceLayerJSON[c].properties&&this.sourceLayerJSON[c].properties.name?this.sourceLayerJSON[c].properties.name:this.name+" - "+$.t("layers.track")+" "+c,b[$.t("layers.simplified")]=this.simplifiedLayerData[c],b[$.t("layers.source")]=this.sourceLayerData[c];this.controller=L.control.layers(null,b,{collapsed:!1}),this.controller.addTo(window.map),$(".leaflet-control-layers-selector").on("click",function(){window.currentLayer.displaySizeFormats()})},displayInfos:function(){var a=$.t("layers.infos.title",{name:this.name}),b=$.t("layers.infos.nodes",{sourcenodes:this.sourceLayerNodes,simplifiednodes:this.simplifiedLayerNodes});$("#filename").html(a),$("#nodes").html(b),$(".leaflet-control-stats").show()},countTracksNodes:function(a){a=a||this.simplifiedLayerData;for(var b=0,c=0,d=0;d<this.size;d++)layer=a[d].getLayers()[0],window.map.hasLayer(layer)&&(b++,c+=layer.toGeoJSON().geometry.coordinates.length);return{tracks:b,nodes:c}},displaySizeFormats:function(){var a=this.countTracksNodes(),b=this.countTracksNodes(this.sourceLayerData),c=window.formats.formats,d="",e=0;$("#size-format .sizes").html(""),e=c[0].getSize(b.tracks,b.nodes,this.rawData,8),d="Original",$("#size-format .sizes").append('<p><span class="format-name">'+d+' :</span><span class="format-size">'+e+"</span></p>");for(var f=0;f<c.length;f++)e=c[f].getSize(a.tracks,a.nodes,this.rawData,this.precision),$("#size-format .sizes").append('<p><span class="format-name">'+c[f].param.name+' :</span><span class="format-size">'+e+"</span></p>");$("#size-format").show()},clearInfos:function(){$("#filename").html(""),$("#nodes").html(""),$(".leaflet-control-stats").hide()},clearSizeFormats:function(){$("#size-format").hide()},remove:function(){this.removeLayers(),this.removeController(),this.clearInfos(),this.clearSizeFormats()},removeLayers:function(){for(var a=0;a<this.size;a++){try{window.map.removeLayer(this.sourceLayerData[a])}catch(b){console.log($.t("layers.error.layer"))}try{window.map.removeLayer(this.simplifiedLayerData[a])}catch(b){console.log($.t("layers.error.layer"))}}},removeController:function(){try{void 0!==this.controller._map&&this.controller.removeFrom(window.map)}catch(a){console.log($.t("layers.error.controller"))}},createId:function(){function a(){return Math.floor(65536*(1+Math.random())).toString(16).substring(1)}return a()+a()+a()+a()}};