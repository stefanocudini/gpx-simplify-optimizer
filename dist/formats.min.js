function filesizeHuman(a,b){if(0===a)return a;b=b||1;var c=$.t("export.units").split(",");return i=parseInt(Math.floor(Math.log(a)/Math.log(1024))),0===i&&(b=0),(a/Math.pow(1024,i)).toFixed(b)+" "+c[i]}function getPosition(a){for(var b=0,c=0;a;)b+=a.offsetLeft-a.scrollLeft+a.clientLeft,c+=a.offsetTop-a.scrollTop+a.clientTop,a=a.offsetParent;return{x:b,y:c}}function hideAll(){$(".popup").each(function(){$(this).hide()}),hideLanguages()}function chooseDownloadFormat(a){hideAll();var b=getPosition(a.currentTarget);$("#download-formats").css("top",b.y-4),$("#download-formats").show()}function chooseViewFormat(a){hideAll();var b=getPosition(a.currentTarget);$("#view-formats").css("top",b.y-4),$("#view-formats").show(),$("#download-formats").hide()}function GeoJSONFormat(){this.param={key:"geojson",syntax:"json",name:"GeoJSON",extension:"geojson",contenttype:"appplication/json",size_header:90,size_track:36,size_node:20,size_node_options:6},this.exportData=function(a){return JSON.stringify(a)},this.display=function(a){return prettyData.json(a)}}function GPXFormat(){this.param={key:"gpx",syntax:"xml",name:"GPX",extension:"gpx",contenttype:"application/gpx+xml",size_header:186,size_track:75,size_node:48,size_node_options:54},this.exportData=function(a,b){if(a.features&&a.features[0].geometry){a.features[0].geometry.times=[];for(var c in a.features[0].geometry.coordinates){var d=a.features[0].geometry.coordinates[c][1]+","+a.features[0].geometry.coordinates[c][0];a.features[0].geometry.times.push(b.rawData[d]&&b.rawData[d].time?b.rawData[d].time:void 0)}}var e=togpx(a);return e},this.display=function(a){return prettyData.xml(a)}}function gpxParser(a){var b=null;return gpxParse.parseGpx(a,function(c,d){if(c)console.log("This GPX file has no tracks. It may be a route... Can not load as true GPX file."),b=convertGPXToGeoJSON(a);else{for(trackNum=0;trackNum<d.tracks.length;trackNum++){var e=d.tracks[trackNum];for(segmentNum=0;segmentNum<e.segments.length;segmentNum++){var f=e.segments[segmentNum];for(pointNum=0;pointNum<f.length;pointNum++){var g=f[pointNum];RAW_DATA[g.lat+","+g.lon]=g}}}b=convertGPXToGeoJSON(a)}}),L.geoJson(b)}function convertGPXToGeoJSON(a){if("string"==typeof a){var b=a.match(/<gpx/i)?"gpx":a.match(/kml/i)?"kml":"geojson";a=(new window.DOMParser).parseFromString(a,"text/xml"),a=toGeoJSON[b](a)}return a}function KMLFormat(){this.param={key:"kml",syntax:"xml",name:"KML",extension:"kml",contenttype:"application/vnd.google-earth.kml+xml",size_header:150,size_track:81,size_node:19,size_node_options:6},this.exportData=function(a){return tokml(a)},this.display=function(a){return prettyData.xml(a)}}function MediawikiFormat(){this.param={key:"mediawiki",syntax:"nohighlight",name:"Mediawiki",extension:"txt",contenttype:"text/plain",size_header:0,size_track:0,size_node:17,size_node_options:0},this.exportData=function(a){return geojsonToPath(a)}}$("#export-close").on("click",function(){$("#export-format").hide()});var Format=function(){this.param={key:"format",name:"RootFormat"},this.formats=[]};Format.prototype={loadAll:function(a){for(var b=0;b<a.length;b++)f=new window[a[b]],f.load(),this.formats.push(f)},load:function(){var a=document.createElement("a"),b=document.createTextNode($.t("export.viewin",{format:this.param.name}));a.appendChild(b),a.title=$.t("export.viewtitle",{format:this.param.name}),a.className="view",$(a).on("click",this.viewClick.bind(this)),$("#view-formats").append(a),a=document.createElement("a"),b=document.createTextNode($.t("export.downloadin",{format:this.param.name})),a.appendChild(b),a.title=$.t("export.downloadtitle",{format:this.param.name}),a.className="download",$(a).on("click",this.saveClick.bind(this)),$("#download-formats").append(a)},display:function(a){return a},getSize:function(a,b,c){return filesizeHuman(this.getEstimatedSize(a,b,c))},getEstimatedSize:function(a,b,c){var d=0;return Object.keys(c).length&&(d=Object.keys(c).length*this.param.size_node_options),this.param.size_header+a*this.param.size_track+b*this.param.size_node+d},groupData:function(a){for(var b,c=a.simplifiedLayerData,d=L.geoJson(null),e=0;e<c.length;e++)window.map.hasLayer(c[e].getLayers()[0])&&(b=c[e].getLayers()[0].toGeoJSON(),d.addData(b));return this.exportData(d.toGeoJSON(),a)},save:function(a){name=a.name.replace(/\..*/,""),name=name+"_"+a.simplifiedLayerNodes+"nodes."+this.param.extension;try{if(new Blob){var b=this.groupData(a),c=new Blob([b],{type:this.param.contenttype+";charset=utf-8"});saveAs(c,name)}}catch(d){alert($.t("upload.none")+" "+d.message),console.log(d.message)}hideAll()},saveClick:function(){this.save(window.currentLayer)},view:function(a){try{if(new Blob){var b=this.groupData(a);b=this.display(b),$("code").attr("class",this.param.syntax),$("#export-content").text(b),a.simplifiedLayerNodes<1e3&&$("code").each(function(a,b){hljs.highlightBlock(b)}),$("#export-format h5").html($.t("export.title",{format:this.param.name})),$("#export-format").show()}}catch(c){alert($.t("upload.none")+" "+c.message),console.log(c.message)}hideAll()},viewClick:function(){this.view(window.currentLayer)}},GeoJSONFormat.prototype=new Format,GPXFormat.prototype=new Format,RAW_DATA={},KMLFormat.prototype=new Format,MediawikiFormat.prototype=new Format;